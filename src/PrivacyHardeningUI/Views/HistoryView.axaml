<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PrivacyHardeningUI.ViewModels"
             x:Class="PrivacyHardeningUI.Views.HistoryView"
             x:DataType="vm:HistoryViewModel">

  <Grid RowDefinitions="Auto,*,Auto" Margin="12">

    <Border Grid.Row="0" Background="{DynamicResource PanelBrush}" Padding="12" CornerRadius="8">
      <Grid ColumnDefinitions="*,Auto">
        <StackPanel Spacing="4">
          <TextBlock Classes="title" Text="History / Undo" />
          <TextBlock Opacity="0.75" Text="Tool-applied changes are tracked for auditability and reversibility." />
        </StackPanel>

        <Button Grid.Column="1" Content="Refresh" Command="{Binding RefreshCommand}" />
      </Grid>
    </Border>

    <Grid Grid.Row="1" Margin="0,12,0,0" ColumnDefinitions="*,420">
      <Border Grid.Column="0" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8">
        <ScrollViewer>
          <ItemsControl ItemsSource="{Binding Sessions}">
            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:HistorySessionViewModel">
                <Expander IsExpanded="{Binding IsExpanded}" Margin="0,0,0,1" BorderThickness="0,0,0,1">
                  <Expander.Header>
                    <Grid ColumnDefinitions="*,Auto" HorizontalAlignment="Stretch">
                      <StackPanel Orientation="Horizontal" Spacing="16">
                        <TextBlock Text="{Binding SessionTitle}" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Opacity="0.6">
                          <TextBlock Text="{Binding SuccessCount, StringFormat=\{0\} ok}"/>
                          <TextBlock Text="{Binding FailureCount, StringFormat=\{0\} fail}" IsVisible="{Binding FailureCount}"/>
                        </StackPanel>
                      </StackPanel>
                      <Button Grid.Column="1" Content="Rollback Session" 
                              Command="{Binding $parent[UserControl].((vm:HistoryViewModel)DataContext).RevertSessionCommand}"
                              CommandParameter="{Binding}"
                              Classes="warning" Padding="8,2" FontSize="11" Margin="10,0"/>
                    </Grid>
                  </Expander.Header>
                  <ItemsControl ItemsSource="{Binding Changes}" Margin="24,0,0,0">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="12">
                          <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                            <TextBlock Grid.RowSpan="2" Grid.Column="0" Width="80" Text="{Binding Operation}" FontWeight="SemiBold" />
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding PolicyId}" FontFamily="Consolas" />
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Description}" Opacity="0.8" TextWrapping="Wrap" />
                            <TextBlock Grid.Row="0" Grid.Column="2" Text="{Binding AppliedAt, StringFormat=\{0:HH:mm:ss\}}" Opacity="0.75" />
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </Expander>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Border>

      <Border Grid.Column="1" Margin="12,0,0,0" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="12">
        <StackPanel Spacing="8">
          <TextBlock FontWeight="SemiBold" Text="Current snapshot" />
          <TextBlock FontFamily="Consolas" FontSize="12" Opacity="0.85" Text="{Binding Snapshot.SnapshotId}" TextWrapping="Wrap" />

          <TextBlock Opacity="0.75" Text="This sprint shows the change timeline. Next: session grouping + revert preview." TextWrapping="Wrap" />
        </StackPanel>
      </Border>
    </Grid>

    <Border Grid.Row="2" Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="10" Margin="0,12,0,0">
      <TextBlock Foreground="{DynamicResource ErrorBrush}" Text="{Binding ErrorMessage}" />
    </Border>

    <Panel Grid.RowSpan="3" IsVisible="{Binding IsLoading}" Background="#40000000">
      <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="18" HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel Spacing="10" HorizontalAlignment="Center">
          <ProgressBar IsIndeterminate="True" Width="240" />
          <TextBlock Text="Loading history" />
        </StackPanel>
      </Border>
    </Panel>

  </Grid>
</UserControl>
