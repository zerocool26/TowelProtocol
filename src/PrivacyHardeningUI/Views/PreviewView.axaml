<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PrivacyHardeningUI.ViewModels"
             xmlns:controls="using:PrivacyHardeningUI.Controls"
             x:Class="PrivacyHardeningUI.Views.PreviewView"
             x:DataType="vm:PreviewViewModel">

  <Grid RowDefinitions="Auto,*,Auto" Margin="12">

    <Border Grid.Row="0" Background="{DynamicResource PanelBrush}" Padding="12" CornerRadius="8">
      <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*">

        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" RowDefinitions="Auto">
          <StackPanel Grid.Column="0" Spacing="4">
            <TextBlock Classes="title" Text="Preview (Diff)" />
            <TextBlock Opacity="0.75" Text="Evidence-first preview. Nothing changes until you apply." />
          </StackPanel>

          <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
            <Button Content="Refresh checks" Command="{Binding RefreshSelectionInfoCommand}" />
            <Button Classes="accent" Content="Generate preview" Command="{Binding GeneratePreviewCommand}" />
          </StackPanel>
        </Grid>

        <Grid Grid.Row="1" ColumnDefinitions="280,180,Auto,Auto,*,Auto" Margin="0,10,0,0" ColumnSpacing="10">
          <TextBox Grid.Column="0" Watermark="Filter by policy ID/name/text" Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" />
          <ComboBox Grid.Column="1" ItemsSource="{Binding MechanismFilters}" SelectedItem="{Binding SelectedMechanismFilter}">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding Label}" />
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>
          <ToggleSwitch Grid.Column="2" Content="Failures only" IsChecked="{Binding ShowOnlyFailures}" />

          <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
            <TextBlock Opacity="0.75" Text="Selected:" />
            <TextBlock FontWeight="SemiBold" Text="{Binding SelectedCount}" />
            <TextBlock Opacity="0.75" Text="Changes:" />
            <TextBlock FontWeight="SemiBold" Text="{Binding ChangeCount}" />
            <Border Background="{DynamicResource ErrorBrush}" CornerRadius="6" Padding="8,2" IsVisible="{Binding HasPreviewFailures}">
              <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold" Text="Preview failures" />
            </Border>
            <Border Background="{DynamicResource WarningBrush}" CornerRadius="6" Padding="8,2" IsVisible="{Binding HasHighRiskSelected}">
              <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold" Text="High risk selected" />
            </Border>
          </StackPanel>

          <TextBlock Grid.Column="5" Opacity="0.75" VerticalAlignment="Center" Text="{Binding LastGeneratedAt, StringFormat='Last: {0:g}'}" />
        </Grid>

        <Border Grid.Row="2" Margin="0,10,0,0" Background="{DynamicResource OverlayLightBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="10" IsVisible="{Binding HasSelectionIssues}">
          <StackPanel Spacing="6">
            <TextBlock FontWeight="SemiBold" Text="Selection health" />
            <ItemsControl ItemsSource="{Binding SelectionIssues}">
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="8,6">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                      <StackPanel Spacing="2">
                        <TextBlock FontWeight="SemiBold" Text="{Binding Title}" />
                        <TextBlock Opacity="0.8" Text="{Binding Details}" TextWrapping="Wrap" />
                      </StackPanel>
                      <Button Grid.Column="1" Content="{Binding ActionLabel}"
                              Command="{Binding $parent[UserControl].((vm:PreviewViewModel)DataContext).ResolveSelectionIssueCommand}"
                              CommandParameter="{Binding}" />
                    </Grid>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>
      </Grid>
    </Border>

    <Grid Grid.Row="1" Margin="0,12,0,0" ColumnDefinitions="420,*,360" ColumnSpacing="12">

      <!-- Left: change list -->
      <Border Grid.Column="0" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="0">
        <ListBox ItemsSource="{Binding Changes}" SelectedItem="{Binding SelectedChange}" Background="Transparent">
          <ListBox.ItemsPanel>
            <ItemsPanelTemplate>
              <VirtualizingStackPanel />
            </ItemsPanelTemplate>
          </ListBox.ItemsPanel>
          <ListBox.ItemTemplate>
            <DataTemplate x:DataType="vm:PreviewChangeRowViewModel">
              <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="10">
                <Grid ColumnDefinitions="Auto,Auto,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="10">

                  <Border Grid.RowSpan="2" Grid.Column="0" CornerRadius="6" Padding="8,2" Background="{Binding StatusBrush}">
                    <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold" Text="{Binding StatusBadge}" />
                  </Border>

                  <controls:IconHelper Grid.Row="0" Grid.Column="1" Name="{Binding MechanismIcon}" />

                  <StackPanel Grid.Row="0" Grid.Column="2" Spacing="2">
                    <TextBlock FontWeight="SemiBold" Text="{Binding PolicyName}" TextTrimming="CharacterEllipsis" />
                    <TextBlock Opacity="0.75" FontFamily="Consolas" Text="{Binding PolicyId}" />
                  </StackPanel>

                  <Border Grid.Row="0" Grid.Column="3" Background="{Binding RiskBrush}" CornerRadius="6" Padding="8,2">
                    <TextBlock Foreground="White" FontSize="12" FontWeight="SemiBold" Text="{Binding RiskBadge}" />
                  </Border>

                  <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="3" Opacity="0.8" Text="{Binding SummaryLine}" TextWrapping="Wrap" />
                </Grid>
              </Border>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>
      </Border>

      <!-- Middle: selected change details -->
      <Border Grid.Column="1" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="12">
        <ScrollViewer>
          <StackPanel Spacing="10">

            <StackPanel IsVisible="{Binding HasSelectedChange}" Spacing="6">
              <TextBlock FontWeight="SemiBold" Text="{Binding SelectedChange.PolicyName}" />
              <StackPanel Orientation="Horizontal" Spacing="10">
                <TextBlock Opacity="0.75" FontFamily="Consolas" Text="{Binding SelectedChange.PolicyId}" />
                <TextBlock Opacity="0.75" Text="·" />
                <TextBlock Opacity="0.75" Text="{Binding SelectedChange.OperationText}" />
                <TextBlock Opacity="0.75" Text="·" />
                <TextBlock Opacity="0.75" Text="{Binding SelectedChange.MechanismText}" />
              </StackPanel>

              <Border Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="10">
                <TextBlock Opacity="0.85" TextWrapping="Wrap" Text="{Binding SelectedChange.Description}" />
              </Border>

              <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,*">
                <TextBlock Grid.Row="0" Grid.Column="0" FontWeight="SemiBold" Text="Before" />
                <TextBlock Grid.Row="0" Grid.Column="1" FontWeight="SemiBold" Text="After" />

                <TextBox Grid.Row="1" Grid.Column="0" FontFamily="Consolas" FontSize="12" IsReadOnly="True" AcceptsReturn="True" TextWrapping="Wrap" MinHeight="160" Text="{Binding SelectedChange.BeforeState}" />
                <TextBox Grid.Row="1" Grid.Column="1" FontFamily="Consolas" FontSize="12" IsReadOnly="True" AcceptsReturn="True" TextWrapping="Wrap" MinHeight="160" Text="{Binding SelectedChange.AfterState}" />
              </Grid>

              <Border Background="{DynamicResource OverlayLightBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="10" IsVisible="{Binding SelectedChange.HasNotes}">
                <StackPanel Spacing="4">
                  <TextBlock FontWeight="SemiBold" Text="Notes" />
                  <TextBlock Opacity="0.8" TextWrapping="Wrap" Text="{Binding SelectedChange.Notes}" />
                </StackPanel>
              </Border>
            </StackPanel>

            <Border IsVisible="{Binding HasNoSelectedChange}" Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="12">
              <TextBlock Opacity="0.75" TextWrapping="Wrap" Text="Select a change on the left to see the mechanism-specific before/after evidence." />
            </Border>

          </StackPanel>
        </ScrollViewer>
      </Border>

      <!-- Right: risk gate + actions -->
      <Border Grid.Column="2" Background="{DynamicResource CardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="12">
        <StackPanel Spacing="10">
          <TextBlock FontWeight="SemiBold" Text="Gate &amp; actions" />
          <TextBlock Opacity="0.75" TextWrapping="Wrap" Text="Preview is non-destructive (dry-run). Apply is a separate step." />

          <Border Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="10">
            <StackPanel Spacing="8">
              <TextBlock FontWeight="SemiBold" Text="Risk gate" />
              <TextBlock Opacity="0.75" TextWrapping="Wrap" Text="High-risk selections require explicit acknowledgement before proceeding." />
              <CheckBox IsVisible="{Binding HasHighRiskSelected}" IsChecked="{Binding HighRiskAcknowledged}" Content="I understand these changes may reduce usability or break features." />
            </StackPanel>
          </Border>

          <Border Background="{DynamicResource OverlayLightBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="10" IsVisible="{Binding HasPreviewFailures}">
            <StackPanel Spacing="4">
              <TextBlock FontWeight="SemiBold" Foreground="{DynamicResource ErrorBrush}" Text="Preview shows failures" />
              <TextBlock Opacity="0.8" TextWrapping="Wrap" Text="If the dry-run reports failures, applying will likely fail for those items. Review the error details in the change list." />
            </StackPanel>
          </Border>

          <Border Background="{DynamicResource OverlayLightBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Padding="10" IsVisible="{Binding HasBlockingSelectionIssues}">
            <StackPanel Spacing="4">
              <TextBlock FontWeight="SemiBold" Foreground="{DynamicResource ErrorBrush}" Text="Conflicts must be resolved" />
              <TextBlock Opacity="0.8" TextWrapping="Wrap" Text="Remove or fix conflicting policies in Selection health before applying." />
            </StackPanel>
          </Border>

          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Classes="accent" Content="Proceed to Apply" Command="{Binding ProceedToApplyCommand}" IsEnabled="{Binding CanProceedToApply}" />
            <Button Content="Regenerate" Command="{Binding GeneratePreviewCommand}" />
          </StackPanel>

          <Border Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="10">
            <TextBlock FontFamily="Consolas" FontSize="12" Opacity="0.85" TextWrapping="Wrap" Text="Tip: After applying, use History/Undo to revert tool-made changes." />
          </Border>
        </StackPanel>
      </Border>

    </Grid>

    <Border Grid.Row="2" Background="{DynamicResource PanelBrush}" CornerRadius="8" Padding="10" Margin="0,12,0,0">
      <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
        <TextBlock Grid.Column="0" Foreground="{DynamicResource ErrorBrush}" Text="{Binding ErrorMessage}" TextWrapping="Wrap" />
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
          <controls:IconHelper Name="info" />
          <TextBlock Opacity="0.75" Text="Evidence is collected from the service." />
        </StackPanel>
      </Grid>
    </Border>

    <Panel Grid.RowSpan="3" IsVisible="{Binding IsLoading}" Background="{DynamicResource OverlayBrush}">
      <Border Background="{DynamicResource CardBrush}" CornerRadius="8" Padding="18" HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel Spacing="10" HorizontalAlignment="Center">
          <ProgressBar IsIndeterminate="True" Width="240" />
          <TextBlock Text="Generating preview…" />
          <TextBlock Opacity="0.75" Text="Collecting evidence from the service" />
        </StackPanel>
      </Border>
    </Panel>

  </Grid>
</UserControl>
