name: "SBOM Generation (Software Bill of Materials)"

on:
  push:
    branches: [ "master", "main" ]
    tags: [ "v*" ]
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  generate-sbom:
    name: Generate SBOM (SPDX & CycloneDX)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Restore and Build
        run: |
          dotnet restore PrivacyHardeningFramework.sln
          dotnet build PrivacyHardeningFramework.sln --configuration Release --no-restore

      - name: Install Microsoft SBOM Tool
        run: dotnet tool install --global Microsoft.Sbom.DotNetTool

      - name: Generate SBOM (SPDX Format)
        run: |
          sbom-tool generate `
            -b . `
            -bc PrivacyHardeningFramework.sln `
            -pn "Windows Privacy Hardening Framework" `
            -pv "1.0.0" `
            -ps "Privacy Hardening Team" `
            -nsb "https://github.com/your-org/privacy-hardening-framework" `
            -BuildDropPath ./sbom-output/spdx `
            -m ./sbom-output/spdx `
            -ManifestDirPath ./sbom-output/spdx

      - name: Install CycloneDX CLI
        run: |
          dotnet tool install --global CycloneDX

      - name: Generate SBOM (CycloneDX Format)
        run: |
          dotnet CycloneDX PrivacyHardeningFramework.sln `
            -o ./sbom-output/cyclonedx `
            -f PrivacyHardeningFramework-SBOM.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: |
            sbom-output/spdx/**
            sbom-output/cyclonedx/**
          retention-days: 90

      - name: Attach SBOM to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sbom-output/spdx/_manifest/spdx_2.2/**
            sbom-output/cyclonedx/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create SBOM Summary
        run: |
          echo "## SBOM Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Formats" >> $GITHUB_STEP_SUMMARY
          echo "- SPDX 2.2" >> $GITHUB_STEP_SUMMARY
          echo "- CycloneDX (latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- CISA 2025 SBOM Guidelines: ✅ Compliant" >> $GITHUB_STEP_SUMMARY
          echo "- NTIA Minimum Elements: ✅ Included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SBOM files available in workflow artifacts and release assets." >> $GITHUB_STEP_SUMMARY
